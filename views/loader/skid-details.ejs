<!-- ==== Skid Details Page ==== -->
<div id="skidDetailsPage" class="page active">
    <h2 class="section-title">
        <i class="fas fa-pallet"></i> Skids for Truck:
        <span id="truckIdentifier"><%= load.truckId %></span>
        (<span id="skidDetailsProjectName"><%= project.name %></span>)
    </h2>

    <p class="intro-paragraph">
        Add skids directly, select from inventory for this project, or edit/remove skids for this load.
        <span id="truckSizeDisplay">
            (<%= load.truckInfo.length %>ft L Ã— <%= load.truckInfo.width %>ft W, <%= load.truckInfo.weight %>lbs Cap.)
        </span>
    </p>

    <!-- Inventory Skid Selection -->
    <% if (inventorySkids && inventorySkids.length > 0) { %>
        <div id="inventorySkidSelectionContainer">
            <h4><i class="fas fa-clipboard-check"></i> Select Inventory Skids to Add to Truck</h4>
            <form action="/loader/truck/<%= project.code %>/skids/add-from-inventory" method="POST">
                <input type="hidden" name="loadId" value="<%= load._id %>">

                <div class="table-responsive">
                    <table id="inventorySkidSelectionTable">
                        <thead>
                        <tr>
                            <th>Add</th>
                            <th>Inv. ID</th>
                            <th>W (ft)</th>
                            <th>L (ft)</th>
                            <th>Wt (lbs)</th>
                            <th>Description</th>
                        </tr>
                        </thead>
                        <tbody id="inventorySkidSelectionBody">
                        <% inventorySkids.forEach(skid => { %>
                            <tr>
                                <td>
                                    <input type="checkbox"
                                           name="selectedSkids"
                                           value="<%= skid.id %>"
                                           id="inv-select-<%= skid.id %>"
                                            <%= skid.alreadyOnTruck ? 'disabled' : '' %>>
                                </td>
                                <td>
                                    <label for="inv-select-<%= skid.id %>"
                                           title="<%= skid.alreadyOnTruck ? 'Already added to truck' : `Select ${skid.id}` %>">
                                        <%= skid.id %>
                                    </label>
                                </td>
                                <td><%= skid.width.toFixed(2) %></td>
                                <td><%= skid.length.toFixed(2) %></td>
                                <td><%= skid.weight.toFixed(2) %></td>
                                <td><%= skid.description || '-' %></td>
                            </tr>
                        <% }); %>
                        </tbody>
                    </table>
                </div>

                <button type="submit" id="addSelectedInventorySkidsBtn" class="btn btn-primary btn-sm">
                    <i class="fas fa-plus-circle"></i> Add Selected Inventory Skids to Truck Load
                </button>
            </form>
        </div>
    <% } %>

    <!-- Add/Edit Skid Form Container -->
    <div class="form-container no-print" id="addTruckSkidFormContainer" style="display: none;">
        <!-- Content will be populated by JavaScript -->
    </div>

    <!-- Action Buttons -->
    <div class="d-flex justify-content-between align-items-center mb-3 mt-3 no-print">
        <div>
            <button class="btn btn-success" id="addTruckSkidBtn" onclick="toggleAddSkidForm()">
                <i class="fas fa-plus"></i> Add Skid Directly to Truck
            </button>
            <form action="/loader/truck/<%= project.code %>/skids/clear" method="POST" style="display:inline;">
                <input type="hidden" name="_method" value="DELETE">
                <input type="hidden" name="loadId" value="<%= load._id %>">
                <button type="submit" id="resetSkidsBtn" class="btn btn-secondary"
                        style="margin-left: 10px;"
                        onclick="return confirm('Are you sure you want to clear all skids from this truck load?')"
                        <%= load.skids.length === 0 ? 'disabled' : '' %>>
                    <i class="fas fa-undo"></i> Reset Truck Skids List
                </button>
            </form>
        </div>
        <a href="/loader/truck/<%= project.code %>/print?loadId=<%= load._id %>" class="btn btn-print" target="_blank">
            <i class="fas fa-print"></i> Print Loading Plan
        </a>
    </div>

    <!-- Truck Skid Table -->
    <h3 class="section-title" style="font-size: 1.2rem; margin-top: 30px; border-bottom: none;">
        <i class="fas fa-truck-loading"></i> Skids Assigned to this Truck Load
    </h3>
    <div class="table-responsive">
        <table id="truckSkidTable">
            <thead>
            <tr>
                <th>Truck Skid #</th>
                <th>Width (ft)</th>
                <th>Length (ft)</th>
                <th>Weight (lbs)</th>
                <th>Description</th>
                <th class="no-print">Actions</th>
            </tr>
            </thead>
            <tbody id="truckSkidTableBody">
            <% if (load.skids && load.skids.length > 0) { %>
                <% load.skids.forEach((skid, index) => { %>
                    <tr>
                        <td><%= index + 1 %></td>
                        <td><%= skid.width.toFixed(2) %></td>
                        <td><%= skid.length.toFixed(2) %></td>
                        <td><%= skid.weight.toFixed(2) %></td>
                        <td>
                            <%= skid.description || '-' %>
                            <% if (skid.originalInvId) { %>
                                <span style="font-size: 0.8em; color: var(--text-muted); white-space: nowrap;">
                                        (from Inv: <%= skid.originalInvId %>)
                                    </span>
                            <% } %>
                        </td>
                        <td class="action-buttons no-print">
                            <a href="#" onclick="editSkid('<%= skid.id %>', <%= index %>); return false;" class="btn-edit btn-sm">
                                <i class="fas fa-edit"></i> Edit
                            </a>
                            <form action="/loader/truck/<%= project.code %>/skid/<%= skid.id %>" method="POST" style="display:inline;">
                                <input type="hidden" name="_method" value="DELETE">
                                <input type="hidden" name="loadId" value="<%= load._id %>">
                                <button type="submit" class="btn-delete btn-sm"
                                        onclick="return confirm('Are you sure you want to remove this skid from the truck?')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </form>
                        </td>
                    </tr>
                <% }); %>
            <% } else { %>
                <tr>
                    <td colspan="6" style="text-align: center;">No skids added to this truck yet.</td>
                </tr>
            <% } %>
            </tbody>
            <tfoot>
            <tr style="font-weight: bold; background-color: var(--light-gray);">
                <td colspan="3">Truck Totals: <span id="totalTruckSkidCount"><%= load.skidCount || 0 %></span> Skids</td>
                <td id="totalTruckSkidWeight"><%= load.totalWeight?.toFixed(2) || '0.00' %> lbs</td>
                <td colspan="2"></td>
            </tr>
            </tfoot>
        </table>
    </div>

    <!-- Loading Instructions -->
    <div class="loading-instructions no-print">
        <div id="loadingInstructions">
            <h5><i class="fas fa-info-circle"></i> Loading Summary & Instructions</h5>
            <p><strong>Summary for Truck <%= load.truckId %>:</strong></p>
            <ul>
                <li>Total Skids on Truck: <%= load.skidCount || 0 %></li>
                <li>Total Weight on Truck: <%= load.totalWeight?.toFixed(2) || '0.00' %> lbs
                    (<%= load.truckInfo.weight ? ((load.totalWeight || 0) / load.truckInfo.weight * 100).toFixed(1) : 0 %>%
                    of <%= load.truckInfo.weight %> lbs capacity)</li>
                <li>Approx. Area Used: <%= spaceUtilization.totalArea.toFixed(2) %> sq ft
                    (<%= spaceUtilization.percentage.toFixed(1) %>% of <%= spaceUtilization.truckArea.toFixed(2) %> sq ft available)</li>
            </ul>

            <% if (isOverweight) { %>
                <p class="warning"><i class="fas fa-exclamation-triangle"></i> Warning: Total weight exceeds truck capacity!</p>
            <% } else if (load.truckInfo.weight && (load.totalWeight || 0) > load.truckInfo.weight * 0.95) { %>
                <p class="warning" style="background-color:#fff3cd;border-color:#ffeeba;color:#856404;">
                    <i class="fas fa-exclamation-circle"></i> Caution: Approaching maximum weight capacity.
                </p>
            <% } %>

            <% if (spaceUtilization.percentage > 100) { %>
                <p class="warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    Warning: Total skid area exceeds theoretical truck floor space. Check stacking/dimensions.
                </p>
            <% } else if (spaceUtilization.percentage > 95 && spaceUtilization.percentage <= 100) { %>
                <p class="warning" style="background-color:#fff3cd;border-color:#ffeeba;color:#856404;">
                    <i class="fas fa-exclamation-circle"></i>
                    Caution: High space utilization. Consider loading arrangement.
                </p>
            <% } %>
        </div>
    </div>

    <!-- Navigation Buttons -->
    <div class="button-group no-print" style="margin-top: 30px;">
        <a href="/loader" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Task Selection
        </a>
        <a href="/loader/truck/<%= project.code %>" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Truck Info
        </a>
        <a href="/loader/truck/<%= project.code %>/packing-list?loadId=<%= load._id %>" class="btn btn-next">
            <i class="fas fa-clipboard-list"></i> Next: Packing List
        </a>
    </div>
</div>

<!-- Skid Form Template -->
<template id="skidFormTemplate">
    <h4 class="skid-form-title-dynamic no-print">Add New Skid</h4>
    <form class="add-skid-form" novalidate>
        <input type="hidden" class="edit-skid-index">
        <input type="hidden" name="loadId" value="<%= load._id %>">
        <div class="row">
            <div class="col-md-3">
                <div class="form-group">
                    <label class="form-label required">Width <span class="unit-label">(ft)</span></label>
                    <div class="input-group">
                        <input type="number" name="width" class="form-control skid-width" min="0.1" max="40" step="0.01" required placeholder="e.g., 4">
                        <span class="input-group-text">ft</span>
                    </div>
                    <div class="invalid-feedback">Please enter a valid width (0.1-40).</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label class="form-label required">Length <span class="unit-label">(ft)</span></label>
                    <div class="input-group">
                        <input type="number" name="length" class="form-control skid-length" min="0.1" max="40" step="0.01" required placeholder="e.g., 4">
                        <span class="input-group-text">ft</span>
                    </div>
                    <div class="invalid-feedback">Please enter a valid length (0.1-40).</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label class="form-label required">Weight <span class="unit-label">(lbs)</span></label>
                    <div class="input-group">
                        <input type="number" name="weight" class="form-control skid-weight" min="1" required placeholder="e.g., 500">
                        <span class="input-group-text">lbs</span>
                    </div>
                    <div class="invalid-feedback">Please enter a valid weight (min 1).</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea name="description" class="form-control skid-description" placeholder="Type description here..." rows="3"></textarea>
                </div>
            </div>
        </div>
        <div class="button-group">
            <button type="button" class="btn btn-secondary cancel-skid-btn" onclick="toggleAddSkidForm()">
                <i class="fas fa-times"></i> Cancel
            </button>
            <button type="submit" class="btn btn-primary save-skid-btn">
                <i class="fas fa-plus"></i> Add Skid
            </button>
        </div>
    </form>
</template>

<%- contentFor('scripts') %>
<script>
    function toggleAddSkidForm() {
        const formContainer = document.getElementById('addTruckSkidFormContainer');
        if (formContainer.style.display === 'none') {
            // Show form
            const template = document.getElementById('skidFormTemplate');
            const content = template.content.cloneNode(true);
            formContainer.innerHTML = '';
            formContainer.appendChild(content);

            // Set up form submission
            const form = formContainer.querySelector('.add-skid-form');
            form.action = '/loader/truck/<%= project.code %>/skid';
            form.method = 'POST';

            // Add hidden input for loadId
            const loadIdInput = document.createElement('input');
            loadIdInput.type = 'hidden';
            loadIdInput.name = 'loadId';
            loadIdInput.value = '<%= load._id %>';
            form.appendChild(loadIdInput);

            formContainer.style.display = 'block';
            setTimeout(() => {
                formContainer.querySelector('.skid-width').focus();
            }, 100);
        } else {
            // Hide form
            formContainer.style.display = 'none';
            formContainer.innerHTML = '';
        }
    }

    // Edit Skid
    function editSkid(skidId, index) {
        const formContainer = document.getElementById('addTruckSkidFormContainer');
        const template = document.getElementById('skidFormTemplate');
        const content = template.content.cloneNode(true);
        formContainer.innerHTML = '';
        formContainer.appendChild(content);

        // Update title and button text
        const titleEl = formContainer.querySelector('.skid-form-title-dynamic');
        titleEl.innerHTML = '<i class="fas fa-edit"></i> Edit Skid #' + (index + 1);

        const saveBtn = formContainer.querySelector('.save-skid-btn');
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';

        // Get skid data
        const skids = <%= JSON.stringify(load.skids) %>;
        const skid = skids.find(s => s.id === skidId);

        if (skid) {
            const form = formContainer.querySelector('.add-skid-form');
            form.action = '/loader/truck/<%= project.code %>/skid/' + skidId + '?_method=PUT';
            form.method = 'POST';

            // Add hidden input for loadId
            const loadIdInput = document.createElement('input');
            loadIdInput.type = 'hidden';
            loadIdInput.name = 'loadId';
            loadIdInput.value = '<%= load._id %>';
            form.appendChild(loadIdInput);

            // Fill form with skid data
            form.querySelector('.skid-width').value = skid.width;
            form.querySelector('.skid-length').value = skid.length;
            form.querySelector('.skid-weight').value = skid.weight;
            form.querySelector('.skid-description').value = skid.description || '';
        }

        formContainer.style.display = 'block';
        setTimeout(() => {
            formContainer.querySelector('.skid-width').focus();
        }, 100);
    }

    // Initialize event listeners when document is ready
    document.addEventListener('DOMContentLoaded', function() {
        // Add event listeners for add skid button
        document.getElementById('addTruckSkidBtn').addEventListener('click', toggleAddSkidForm);

        // Set up form validation for all forms
        document.addEventListener('submit', function(e) {
            if (e.target.classList.contains('add-skid-form')) {
                const form = e.target;
                if (!form.checkValidity()) {
                    e.preventDefault();
                    e.stopPropagation();

                    // Show validation messages
                    const inputs = form.querySelectorAll('[required]');
                    inputs.forEach(input => {
                        if (!input.validity.valid) {
                            input.classList.add('is-invalid');
                        } else {
                            input.classList.remove('is-invalid');
                        }
                    });

                    // Focus first invalid input
                    const firstInvalid = form.querySelector('.is-invalid');
                    if (firstInvalid) {
                        firstInvalid.focus();
                    }
                }
            }
        });
    });
    // Form validation
    document.addEventListener('submit', function(e) {
        if (e.target.classList.contains('add-skid-form')) {
            const form = e.target;
            if (!form.checkValidity()) {
                e.preventDefault();
                e.stopPropagation();

                // Show validation messages
                const inputs = form.querySelectorAll('[required]');
                inputs.forEach(input => {
                    if (!input.validity.valid) {
                        input.classList.add('is-invalid');
                    } else {
                        input.classList.remove('is-invalid');
                    }
                });

                // Focus first invalid input
                const firstInvalid = form.querySelector('.is-invalid');
                if (firstInvalid) {
                    firstInvalid.focus();
                }
            }
        }
    });
</script>

<%- contentFor('styles') %>
<style>
    .input-group {
        display: flex;
        align-items: stretch;
    }

    .input-group .form-control {
        flex: 1;
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
    }

    .input-group-text {
        display: flex;
        align-items: center;
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        font-weight: 400;
        line-height: 1.5;
        color: var(--dark-gray);
        text-align: center;
        white-space: nowrap;
        background-color: var(--medium-gray);
        border: 1px solid #ced4da;
        border-left: 0;
        border-radius: 0 var(--border-radius) var(--border-radius) 0;
    }

    /* Mobile adjustments */
    @media (max-width: 768px) {
        .row {
            flex-direction: column;
        }

        .col-md-3 {
            width: 100%;
        }
    }
</style>